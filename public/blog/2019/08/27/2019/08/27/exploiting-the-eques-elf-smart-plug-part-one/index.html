<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Exploiting the Eques Elf Smart Plug Part One - The poetry of (in)security</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="I bought some smart power plugs and they were pretty awesome! These are the Eques Elf smart plugs. They can be controlled using an app through a connected Wi-Fi network, and remotely over the internet.
Everything was going on well till I noticed some strange urls on my home network monitoring system. It turns out it was the smart plug constantly communicating with some external hosts." />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Exploiting the Eques Elf Smart Plug Part One" />
<meta property="og:description" content="I bought some smart power plugs and they were pretty awesome! These are the Eques Elf smart plugs. They can be controlled using an app through a connected Wi-Fi network, and remotely over the internet.
Everything was going on well till I noticed some strange urls on my home network monitoring system. It turns out it was the smart plug constantly communicating with some external hosts." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/blog/2019/08/27/2019/08/27/exploiting-the-eques-elf-smart-plug-part-one/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-08-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-08-27T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Exploiting the Eques Elf Smart Plug Part One"/>
<meta name="twitter:description" content="I bought some smart power plugs and they were pretty awesome! These are the Eques Elf smart plugs. They can be controlled using an app through a connected Wi-Fi network, and remotely over the internet.
Everything was going on well till I noticed some strange urls on my home network monitoring system. It turns out it was the smart plug constantly communicating with some external hosts."/>

        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">The poetry of (in)security</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Exploiting the Eques Elf Smart Plug Part One</h1>
          <div class="meta">Posted on Aug 27, 2019</div>
        </div>
        
        <section class="body">
          <p>I bought some smart power plugs and they were pretty awesome! These are the <!-- raw HTML omitted --><strong>Eques Elf smart plugs.</strong><!-- raw HTML omitted --> They can be controlled using an app through a connected Wi-Fi network, and remotely over the internet.</p>
<p>Everything was going on well till I noticed some strange urls on my home network monitoring system. It turns out it was the smart plug constantly communicating with some external hosts.</p>
<p>My smart plugs were not in my full control! Our journey therefore begins. It was time to void some warranties, figure out what was going on, and hopefully gain full control of the plug.</p>
<p>This is a walkthrough of the process I took and will be broken down into the following areas:</p>
<ul>
<li>Network traffic analysis</li>
<li>Android app reversing</li>
<li>Dynamic instrumentation</li>
<li>Native library debugging</li>
<li>Native library reversing</li>
<li>Custom exploit tools/scripts</li>
<li>Hardware teardown</li>
</ul>
<p>The end goal will be to:</p>
<ul>
<li>Gain full control of the smart plug</li>
<li>Discover any security vulnerabilities</li>
<li>Develop exploitation techniques and tools</li>
</ul>
<h1 id="part-one-the-homesick-elf-some-packets-and-an-analyst">Part One: The homesick elf, some packets and an analyst</h1>
<p>I set up my network as below:</p>
<p>{% img /images/mirror_setup.png %}</p>
<p>The app and smart plug are connected to the same WIFI network. All traffic in the network is mirrored and sent to the Raspberry Pi, which has Zeek IDS set up. The logs are then analysed and visualised by a Graylog server.</p>
<p>We will then run the app and analyse the traffic.</p>
<p>First thing I noted were the following hosts communicating with the app:</p>
<ul>
<li><a href="https://cnctlife.com">https://cnctlife.com</a></li>
<li><a href="http://ikonke.us/">http://ikonke.us/</a></li>
<li><a href="https://ikonke.us:50003/">https://ikonke.us:50003/</a></li>
<li><a href="https://router-a0-push.leancloud.cn">https://router-a0-push.leancloud.cn</a></li>
<li><a href="http://ikonkek2.com:9123">http://ikonkek2.com:9123</a></li>
<li><a href="http://ikonkek2.com:5222">http://ikonkek2.com:5222</a></li>
</ul>
<p>And the follwoing communicating with the smart plug:</p>
<ul>
<li><a href="http://ikonkek2.com:9123">http://ikonkek2.com:9123</a></li>
<li><a href="http://ikonkek2.com:5222">http://ikonkek2.com:5222</a></li>
</ul>
<p>The first communication I noticed were repeated packets being sent to the broadcast address by the app on udp port 27431.</p>
<p>{% img /images/udp_27431_2.png %}</p>
<p>Following the udp stream, we can see that the data is sent repeatedly. The suspicion is that this is the plug discovery process by the app.</p>
<p>{% img /images/udp_27431.png %}</p>
<p>The app then starts communicating with ikonkek2.com on port 9123.</p>
<p>{% img /images/synchofriends.png %}</p>
<p>Some more of the sample data sent and the responses can be seen here:</p>
<p>+++</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>getDeviceInfo:8S6cW/8R2lxEiAF9Vq8maDQbEtAhNrSn1AO5aa9rV2fx7gFo+8WXHSEERZkoj0cI2kuhoJz/TMH4cOF0cH5luA<span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>hEJJ9YjsfWTlB0j8h3xFVJSZPLiVeqXqwm2+VYc2hReeeuO61tEz+9XcaNZwJo3o7aPMxgJwsDDgFcH+HDwChklPvnRC5bPqrpHzLyZK9g0<span style="color:#f92672">=</span>
</span></span></code></pre></div><p>+++</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>getDeviceStatus:8S6cW/8R2lxEiAF9Vq8maDQbEtAhNrSn1AO5aa9rV2eOvkUKU+0kgmaR7hkY2JLP
</span></span><span style="display:flex;"><span>hEJJ9YjsfWTlB0j8h3xFVJSZPLiVeqXqwm2+VYc2hReUX1M+EvqrQUuw1Ag/eSc0
</span></span></code></pre></div><p>+++</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>moduleReport:z8gm9VQHmkywT3J7rp2SUFUpHUkb3JTG8b/dcozM8q6cW6fwp40tS9YByPwuCUYqa+G4gNtEuPfLOJqf+mBdXF2Zw0dUEZLUaDsUiJxTepM<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>.hEJJ9YjsfWTlB0j8h3xFVFUpHUkb3JTG8b/dcozM8q6cW6fwp40tS9YByPwuCUYqW/Aap48EIhkq+31whfFKne06Nhp1WmLYxu89+vi0sqk<span style="color:#f92672">=</span>
</span></span></code></pre></div><p>+++</p>
<p>We will come to these messages later. For now note that port 9123 is commonly used by Apache Mina Servers.</p>
<p>When we turn the plug on or off from the app, an XMPP connection is initiated. The app first authenticates to the server using DIGEST-MD5 mechanism.</p>
<p>The app then initiates and xmpp chat to <a href="mailto:dc-4f-22-25-xx-xx@ikonkek2.com">dc-4f-22-25-xx-xx@ikonkek2.com</a> using the username <!-- raw HTML omitted --><a href="mailto:d4-63-c6-8d-xx-xxeques@ikonkek2.com">d4-63-c6-8d-xx-xxeques@ikonkek2.com</a>/android<!-- raw HTML omitted -->. Note that <!-- raw HTML omitted -->dc-4f-22-25-xx-xx<!-- raw HTML omitted --> is the mac address of the smart plug while <!-- raw HTML omitted -->d4-63-c6-8d-xx-xx<!-- raw HTML omitted --> is the mac address of the phone running the app.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>XMPP Protocol
</span></span><span style="display:flex;"><span>    MESSAGE <span style="color:#f92672">[</span>id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;26xzR-5&#34;</span> type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        from: d4-63-c6-8d-xx-xxeques@ikonkek2.com/android
</span></span><span style="display:flex;"><span>        id: 26xzR-5
</span></span><span style="display:flex;"><span>        to: dc-4f-22-25-xx-xx@ikonkek2.com
</span></span><span style="display:flex;"><span>        type: chat
</span></span><span style="display:flex;"><span>        THREAD <span style="color:#f92672">[</span>value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bB3Fe0&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        BODY <span style="color:#f92672">[</span>value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;encryption:88fL6ftH5a/VVZrG4oNejdQ9GajxiNsSbvgVs8aR9inGr6gePzDWTU8IMejrHRxbhrtt27ImZpCvsN9MXbi42RKt2aQ4NsNEwNWwDj1OYLY=&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            value: encryption:88fL6ftH5a/VVZrG4oNejdQ9GajxiNsSbvgVs8aR9inGr6gePzDWTU8IMejrHRxbhrtt27ImZpCvsN9MXbi42RKt2aQ4NsNEwNWwDj1OYLY<span style="color:#f92672">=</span>
</span></span></code></pre></div><p>+++</p>
<p>The plug then responds to the message:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>XMPP Protocol
</span></span><span style="display:flex;"><span>    MESSAGE <span style="color:#f92672">[</span>type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        from: dc-4f-22-25-xx-xx@ikonkek2.com/device
</span></span><span style="display:flex;"><span>        to: d4-63-c6-8d-xx-xxeques@ikonkek2.com/android
</span></span><span style="display:flex;"><span>        type: chat
</span></span><span style="display:flex;"><span>        xml:lang: en
</span></span><span style="display:flex;"><span>        BODY <span style="color:#f92672">[</span>value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;encryption:z8gm9VQHmkywT3J7rp2SUFUpHUkb3JTG8b/dcozM8q5RCCP4wzJPMrgxjWeeFZicog7NzWKq9DncBNIGR530/Q==&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            value: encryption:z8gm9VQHmkywT3J7rp2SUFUpHUkb3JTG8b/dcozM8q5RCCP4wzJPMrgxjWeeFZicog7NzWKq9DncBNIGR530/Q<span style="color:#f92672">==</span>
</span></span></code></pre></div><p>Note that the chat messages start with the prefix <em>encryption:</em>.</p>
<p>+++</p>
<h1 id="what-we-know-so-far">What we know so far</h1>
<ul>
<li>
<p>The smart plug listens on UDP 27431. The app sends udp broadcast messages on this port to discover the plug and the ommunication looks encrypted/encoded.</p>
</li>
<li>
<p>The app communicates with the host ikonkek2.com on ports:</p>
<ul>
<li>
<p>9123 (Apache Mina)</p>
<p>-&gt; Communication looks partially encrypted/encoded and happens regularly.</p>
<p>-&gt; Messages follow the format - <em>descriptive prefix</em>:<em>some encrypted/encoded message</em>.</p>
</li>
<li>
<p>5222 (XMPP)</p>
<p>-&gt; Communication is initiated when the plug is turned on/off from the app.</p>
<p>-&gt; Communication looks to be through encrypted/encoded chat messages.</p>
<p>-&gt; The username of the phone is based on the phone mac address with the word eques appended.</p>
<p>-&gt; The username of the plug is just its mac address.</p>
<p>-&gt; Authentication with the xmpp server (ikonkek2.com) is DIGEST-MD5.</p>
<p>-&gt; XMPP Messages follow the format - <em>encryption</em>:<em>some encrypted/encoded message</em>.</p>
</li>
</ul>
</li>
</ul>
<p>+++</p>
<p>In part two we are going to dig further by looking at the android application itself.</p>
        </section>
        <div class="post-tags">
          
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/iamckn" rel="me" title="GitHub"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github" />
</svg></a><a class="border"></a><a class="soc" href="https://twitter.com/iamckn/" rel="me" title="Twitter"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#twitter" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>

</div>
    </body>
</html>
